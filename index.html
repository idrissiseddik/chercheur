<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Recherche Code à Barre – Tous les Produits</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f8;
      color: #333;
      margin-bottom: 100px;
      line-height: 1.6;
    }
    h2 {
      color: #0d47a1;
      font-weight: 600;
      margin-top: 30px;
    }
    .input-group {
      max-width: 600px;
      margin: 20px auto;
    }
    .card {
      border: 3px solid #2196f3; /* Bordure bleue plus épaisse */
      border-radius: 12px;
      padding: 20px;
      background-color: #fff;
      box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
      margin-bottom: 20px;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0px 8px 15px rgba(0, 0, 0, 0.2);
    }
    .card img {
      width: 100%;
      height: auto;
      border-radius: 8px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .card img:hover {
      transform: scale(1.05);
    }
    .card .product-name {
      font-size: 1.25rem;
      font-weight: 600;
      color: #0d47a1;
      margin-bottom: 10px;
    }
    .card .product-info {
      font-size: 1rem;
      color: #555;
    }
    .card .product-info p {
      margin-bottom: 5px;
    }
    .pagination .page-link {
      border: none;
      color: #0d47a1;
      background-color: #e3f2fd;
      border-radius: 50px;
      margin: 0 5px;
      font-weight: bold;
    }
    .footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #0d47a1;
      color: white;
      text-align: center;
      padding: 12px 0;
      font-size: 0.9rem;
      z-index: 1000;
    }
    .footer a {
      color: #ffeb3b;
      text-decoration: none;
    }
    svg {
      margin-top: 10px;
    }

    #loading {
      font-size: 1.5rem;
      font-weight: bold;
      color: #0d47a1;
      text-align: center;
      animation: bounce 1s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-15px); }
    }

    .btn-copy {
      background-color: #00bcd4;
      color: white;
      border: none;
      font-size: 1rem;
      font-weight: bold;
      transition: background-color 0.3s;
    }

    .btn-copy:hover {
      background-color: #0097a7;
    }

    #overlayMessage {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 99999;
      display: none;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
    }

    .overlay-content {
      color: white;
      max-width: 800px;
      margin: auto;
      font-family: 'Arial', sans-serif;
    }

    .overlay-text {
      font-size: 2.5rem;
      line-height: 1.8;
      direction: rtl;
      animation: fadeIn 1.5s ease-in-out;
    }

    .overlay-content button {
      font-size: 1.5rem;
      font-weight: bold;
      margin-top: 20px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    /* Fond blanc pour le message défilant */
    #fixedMessage {
      position: sticky;
      top: 0;
      background-color: #fff;
      padding: 8px 0;
      font-weight: normal;
      font-size: 1rem;
      color: #0d47a1;
      z-index: 1051;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    #fixedMessage marquee {
      font-size: 1.2rem;
      font-weight: normal;
      color: #0d47a1;
    }

    /* Fond jaune clair pour la barre de recherche */
    .sticky-top {
      background-color: #fff8dc !important;
      z-index: 1050;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="sticky-top">
    <!-- Message défilant avec fond blanc -->
    <div id="fixedMessage">
      <marquee behavior="scroll" direction="right" scrollamount="4">
        ما تنساش إلى بغيتي تكوبي الكود كليكيي على الصورة *** وفي البحث ديما دير سويفون
      </marquee>
    </div>

    <!-- Barre de recherche avec fond jaune clair -->
    <h2 class="text-center mb-3"><i class="fas fa-barcode me-2"></i>Recherche de Produits</h2>
    <div class="input-group mb-3">
      <input type="text" id="searchInput" class="form-control" placeholder="Nom ou début du code à barre..." onkeyup="rechercherArticle()" />
      <button class="btn btn-primary" onclick="rechercherArticle()"><i class="fas fa-search"></i></button>
    </div>
  </div>

  <div id="resultats" class="row gy-4 mt-4"></div>
  <div id="loading" class="text-center text-primary my-3" style="display: none;">Chargement...</div>

  <nav class="mt-4 mb-5">
    <ul class="pagination justify-content-center">
      <li class="page-item"><button class="page-link" onclick="changerPage('prev')">Précédent</button></li>
      <li class="page-item"><button class="page-link" onclick="changerPage('next')">Suivant</button></li>
    </ul>
  </nav>
</div>

<div class="footer">
  Powered by <a href="https://mescreations.vercel.app" target="_blank">M.Seddik Elidrissi</a>
</div>

<!-- Modal Produit -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-white">
      <div class="modal-header border-0">
        <h5 class="modal-title">Produit</h5>
        <button type="button" class="btn-close text-danger" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="modalImage" class="img-fluid mb-3" />
        <svg id="modalBarcode"></svg>
        <div class="d-grid gap-2 mt-3">
          <button class="btn btn-copy" onclick="copierCodeBarre()">
            <i class="fas fa-copy me-1"></i> Copier le code-barres
          </button>
          <button class="btn btn-danger" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i> Fermer
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Message plein écran -->
<div id="overlayMessage">
  <div class="overlay-content">
    <p class="overlay-text">
      إلا استفدتي من هاد الموقع، ما تنساش دعيوة ديال الخير... خوكُم مولاي الصديق الإدريسي
    </p>
    <button class="btn btn-light btn-lg" onclick="fermerOverlay()">مرحبا، شكرًا</button>
  </div>
</div>

<!-- Toast -->
<div class="position-fixed top-50 start-50 translate-middle" style="z-index: 99999;">
  <div id="toastCode" class="toast align-items-center text-white bg-success border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body text-center w-100 fs-5">
        ✅ تم نسخ الكود بنجاح !
      </div>
    </div>
  </div>
</div>

<script>
  let pageActuelle = 1;
  const resultatsParPage = 10;
  let produitsTrouves = [];
  let termeRecherche = "";

  function rechercherArticle() {
    termeRecherche = document.getElementById('searchInput').value.trim().toLowerCase();
    pageActuelle = 1;
    if (termeRecherche.length >= 2) {
      chargerTousLesProduits();
    } else {
      document.getElementById('resultats').innerHTML = "";
    }
  }

  function chargerTousLesProduits() {
    const resultats = document.getElementById('resultats');
    const loading = document.getElementById('loading');
    resultats.innerHTML = "";
    loading.style.display = "block";

    const callbackName = 'cb_' + Math.random().toString(36).substring(2);
    window[callbackName] = function(data) {
      delete window[callbackName];
      document.head.removeChild(script);
      loading.style.display = "none";

      produitsTrouves = data.products.filter(p => {
        const nomMatch = p.product_name && p.product_name.toLowerCase().includes(termeRecherche);
        const codeMatch = p.code && p.code.startsWith(termeRecherche);
        const codeValide = p.code && p.code.length >= 8 && p.code.length <= 13;
        return codeValide && (nomMatch || codeMatch);
      });

      afficherProduitsParPage(pageActuelle);
    };

    const script = document.createElement('script');
    script.src = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(termeRecherche)}&search_simple=1&page_size=1000&json=1&callback=${callbackName}`;
    document.head.appendChild(script);
  }

  function afficherProduitsParPage(page) {
    const resultats = document.getElementById('resultats');
    resultats.innerHTML = "";

    const start = (page - 1) * resultatsParPage;
    const end = page * resultatsParPage;
    const produitsPage = produitsTrouves.slice(start, end);

    if (produitsPage.length === 0) {
      resultats.innerHTML = "<div class='alert alert-info text-center'>Aucun produit à afficher sur cette page.</div>";
      return;
    }

    produitsPage.forEach((prod, i) => {
      const code = prod.code || 'Inconnu';
      const nom = prod.product_name || 'Produit sans nom';
      const image = prod.image_front_url || '';
      const marque = prod.brands || 'Inconnue';
      const pays = prod.countries_fr || 'Inconnu';

      const div = document.createElement('div');
      div.className = "col-md-6";
      div.innerHTML = `
        <div class="card">
          <h5 class="card-title product-name"><i class="fas fa-cube me-2"></i>${nom}</h5>
          <p class="product-info"><strong>Code :</strong> ${code}</p>
          <p class="product-info"><strong>Marque :</strong> ${marque}</p>
          <p class="product-info"><strong>Pays :</strong> ${pays}</p>
          ${image ? `<img src="${image}" onclick="ouvrirImage('${image}', '${code}')" />` : ''}
          <svg id="barcode${i}"></svg>
        </div>
      `;
      resultats.appendChild(div);

      JsBarcode(`#barcode${i}`, code, {
        format: "EAN13",
        displayValue: true,
        fontSize: 14
      });
    });
  }

  function changerPage(direction) {
    if (direction === 'next' && pageActuelle * resultatsParPage < produitsTrouves.length) {
      pageActuelle++;
      afficherProduitsParPage(pageActuelle);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } else if (direction === 'prev' && pageActuelle > 1) {
      pageActuelle--;
      afficherProduitsParPage(pageActuelle);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }

  function ouvrirImage(url, code) {
    document.getElementById("modalImage").src = url;
    JsBarcode("#modalBarcode", code, {
      format: "EAN13",
      displayValue: true,
      fontSize: 16
    });
    new bootstrap.Modal(document.getElementById('imageModal')).show();
  }

  function copierCodeBarre() {
    const code = document.getElementById("modalBarcode").textContent || "";
    navigator.clipboard.writeText(code).then(() => {
      const toastEl = document.getElementById('toastCode');
      const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
      toast.show();
    }).catch(() => {
      alert("❌ Impossible de copier le code.");
    });
  }

  window.addEventListener("load", () => {
    setTimeout(() => {
      document.getElementById("overlayMessage").style.display = "flex";
    }, 1000);
  });

  function fermerOverlay() {
    document.getElementById("overlayMessage").style.display = "none";
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
